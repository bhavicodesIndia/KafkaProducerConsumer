name: Spring Boot CI/CD Pipeline to AWS EC2

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build & Deploy Spring Boot App to AWS EC2
    runs-on: ubuntu-latest

    steps:
      # üß© Step 1 ‚Äî Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # üß© Step 2 ‚Äî Set up JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # üß© Step 3 ‚Äî Build with Maven
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # üß© Step 4 ‚Äî Copy JAR to EC2
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "target/*.jar"
          target: "/home/${{ secrets.EC2_USER }}/app/"

      # üß© Step 5 ‚Äî Restart the Spring Boot app on EC2
      - name: Restart Spring Boot App
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üîπ Navigating to app directory..."
            cd /home/${{ secrets.EC2_USER }}/app

            echo "üîπ Stopping any running Spring Boot process..."
            pkill -f '${{ secrets.APP_NAME }}' || true

            echo "üîπ Starting new version..."
            nohup java -jar /home/${{ secrets.EC2_USER }}/app/${{ secrets.APP_NAME }} > app.log 2>&1 &

            sleep 5
            echo "‚úÖ Spring Boot App Deployed Successfully!"

      # üß© Step 6 ‚Äî Optional: Verify the app is running on port 8080
      - name: Verify App Health
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üîç Checking if app is running..."
            if sudo lsof -i:8080; then
              echo "‚úÖ Port 8080 is active ‚Äî app is running!"
            else
              echo "‚ùå App not detected on port 8080 ‚Äî check app.log"
              cat /home/${{ secrets.EC2_USER }}/app/app.log | tail -n 20
              exit 1
            fi
