name: Spring Boot CI/CD Pipeline to AWS EC2

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build & Deploy Spring Boot App to AWS EC2
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© Step 1 â€” Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # ğŸ§© Step 2 â€” Set up JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # ğŸ§© Step 3 â€” Build with Maven
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # ğŸ§© Step 4 â€” Copy JAR to EC2
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "target/*.jar"
          target: "/home/${{ secrets.EC2_USER }}/app"
          strip_components: 1
          debug: true


          # ğŸ§© Step 5 â€” Restart the Spring Boot app
      - name: Restart Spring Boot App
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: false
          command_timeout: 15m
          script: |
            echo "ğŸ”¹ Navigating to app directory..."
            cd /home/${{ secrets.EC2_USER }}/app
            
            echo "ğŸ”¹ Listing files..."
            ls -lh
            
            if [ ! -f "${{ secrets.APP_NAME }}" ]; then
              echo "âŒ ERROR: JAR file not found â€” deployment aborted!"
              exit 1
            fi
            
            echo "ğŸ”¹ Stopping any running Spring Boot process..."
            pkill -f '${{ secrets.APP_NAME }}' || true
            
            echo "ğŸ”¹ Starting new version in background..."
            nohup java -jar /home/${{ secrets.EC2_USER }}/app/${{ secrets.APP_NAME }} > app.log 2>&1 &
            disown
            
            sleep 8
            echo "âœ… Spring Boot App started successfully!"
            echo "ğŸ” Checking running process..."
            ps aux | grep java

      # ğŸ§© Step 6 â€” Verify that the app is running on port 8080
      - name: Verify App Health
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ” Checking if app is running..."
            if sudo lsof -i:8080; then
              echo "âœ… Port 8080 is active â€” app is running!"
            else
              echo "âŒ App not detected on port 8080 â€” showing recent logs:"
              tail -n 20 /home/${{ secrets.EC2_USER }}/app/app.log
              exit 1
            fi
